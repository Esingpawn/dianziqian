# API字段验证工具使用指南

本文档介绍如何使用API字段验证工具来确保API响应格式和字段命名符合规范。这些工具旨在帮助团队成员找出并修复不符合API字段统一指南的问题。

## 目录

1. [概述](#概述)
2. [前置条件](#前置条件)
3. [单元测试](#单元测试)
4. [命令行验证工具](#命令行验证工具)
5. [代码审查工具](#代码审查工具)
6. [CI/CD集成](#cicd集成)
7. [最佳实践](#最佳实践)

## 概述

API字段验证工具集包含以下组件：

1. **单元测试** - 测试API响应是否符合标准格式和字段命名
2. **命令行验证工具** - 检查特定API响应文件是否符合规范
3. **代码审查工具** - 扫描项目代码，找出不符合规范的地方
4. **CI/CD集成** - 在持续集成流程中自动检查API格式

## 前置条件

使用这些工具前，请确保：

1. 已安装Node.js (v14或更高版本)
2. 已安装所需依赖：`npm install glob`
3. 项目结构符合预期

## 单元测试

单元测试位于`tests/api-validator.test.js`，用于测试API响应格式和字段命名。

### 运行单元测试

```bash
# 运行所有测试
npm test

# 只运行API验证测试
npm test -- -t "API响应格式和字段命名测试"
```

### 测试内容

单元测试主要测试以下方面：

1. **响应格式测试** - 验证API响应是否符合标准格式
2. **模块字段测试** - 验证各模块字段是否使用标准命名
3. **字段转换测试** - 验证旧字段到标准字段的转换是否正确

### 添加新测试

如需添加新的测试用例，请编辑`tests/api-validator.test.js`文件，添加新的测试块：

```javascript
test('新测试用例', () => {
  // 测试代码
  expect(result).toBe(expected);
});
```

## 命令行验证工具

命令行工具`scripts/api-validator-cli.js`用于检查特定API响应文件是否符合规范。

### 使用方法

```bash
node scripts/api-validator-cli.js <文件路径> <模块名称>
```

例如：

```bash
node scripts/api-validator-cli.js ./tests/responses/user-response.json user
```

### 支持的模块

- `user` - 用户模块
- `contract` - 合同模块
- `enterprise` - 企业模块
- `seal` - 印章模块
- `template` - 模板模块

### 输出说明

工具将输出验证结果，包括：

- 验证是否通过
- 响应格式是否正确
- 字段命名是否规范
- 检测到的非标准字段及建议

如果发现非标准字段，工具还会输出转换后的标准字段和标准响应格式建议。

## 代码审查工具

代码审查工具`scripts/code-reviewer.js`用于扫描项目代码，找出不符合API规范的地方。

### 使用方法

```bash
node scripts/code-reviewer.js <目录路径>
```

例如：

```bash
node scripts/code-reviewer.js ./server/src
```

### 扫描内容

工具会扫描指定目录下的所有JavaScript和TypeScript文件，检查：

1. 非标准字段名的使用
2. 非标准API端点路径
3. 其他可能的格式问题

### 输出说明

工具将输出审查结果，包括：

- 总文件数和有问题的文件数
- 问题最多的文件列表
- 详细问题说明，包括文件路径、行号、代码片段、问题描述和修复建议
- 整体修复建议

## CI/CD集成

通过GitHub Actions工作流`.github/workflows/api-validation.yml`，可以在CI/CD流程中自动检查API格式。

### 触发条件

工作流在以下情况下触发：

- 向main或develop分支推送代码，且修改了API相关文件
- 向main或develop分支提交PR，且修改了API相关文件

### 工作流程

1. 签出代码并设置环境
2. 安装依赖
3. 提取API响应样本并验证格式
4. 对服务端、小程序和Web端代码进行审查
5. 生成审查报告并上传为构建产物

### 查看结果

构建完成后，可在GitHub Actions页面查看结果：

1. 如果发现API字段不规范问题，将显示警告
2. 可下载审查报告查看详细问题

## 最佳实践

为确保API字段规范一致，建议：

1. **提交前自检** - 在提交代码前，使用命令行工具检查API响应格式
2. **定期审查** - 定期使用代码审查工具扫描项目代码
3. **及时修复** - 发现问题后及时修复，不要积累技术债务
4. **使用中间件** - 在服务端使用响应处理中间件自动转换字段名
5. **新代码遵循规范** - 新编写的代码应严格遵循API字段统一指南

### 修复建议

1. 使用`server/src/middlewares/response.middleware.js`中间件自动转换字段名
2. 在返回API响应前使用`utils/api-validator.js`中的`convertToStandardFields`函数
3. 更新代码中的字段引用，使用标准字段名

遵循本指南，可以有效减少由于API不一致导致的bug，提高开发效率和代码质量。 